error_log /dev/stderr;

daemon off;
pid nginx.pid;
worker_processes 2;

events {
  worker_connections 1024;
}

http {
  passenger_root $PASSENGER_ROOT;
  passenger_ruby $RUBY_PATH;
  passenger_max_pool_size 10;

  include mime.types;

  access_log /dev/stdout;
  server {
    listen $LOADBALANCER_HTTP_PORT;
    server_name _;

    set $host_without_www $host;
    if ($host = "www.$FQDN") {
      set $host_without_www $FQDN;
    }
    return 301 https://$host_without_www:$LOADBALANCER_HTTPS_PORT$request_uri;
  }

  server {
    server_name www.$FQDN;
    listen $LOADBALANCER_HTTPS_PORT ssl spdy;

    ssl on;
    ssl_certificate certificates/$FQDN.crt;
    ssl_certificate_key certificates/$FQDN.key;
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;

    ssl_ciphers RC4:HIGH:!kEDH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    return 301 https://$FQDN$request_uri;
  }

  server {
    client_max_body_size 64M;
    server_name $FQDN;

    listen $LOADBALANCER_HTTPS_PORT ssl spdy;

    if ($host = "www.$FQDN") {
      return 301 https://$FQDN$request_uri;
    }

    ssl on;
    ssl_certificate certificates/$FQDN.crt;
    ssl_certificate_key certificates/$FQDN.key;
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;

    ssl_ciphers RC4:HIGH:!kEDH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location /favicon.ico {
      return 404;
    }

    location /assets/ {
      alias $ASSETS_PATH;
    }
  }

  server {
    passenger_app_env development;
    root $RAILS_ROOT/api/public;
    passenger_enabled on;

    client_max_body_size 64M;
    server_name api.$FQDN;

    listen $LOADBALANCER_HTTPS_PORT ssl spdy;

    ssl on;
    ssl_certificate certificates/$FQDN.crt;
    ssl_certificate_key certificates/$FQDN.key;
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;

    ssl_ciphers RC4:HIGH:!kEDH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
  }
}
