#!/usr/bin/env bash

function echoStep {
  printf $'\e[37;44m\033[1m'"$1"
  echo $'\033[0m'
}

echoStep "Setting up RBlog environment."

if [ ! -d ".git" ]; then
  echoStep "You should run this script from the git repository root of RBlog"
  exit
fi

# Resetting repo to 'just' cloned state.
git clean -ffdx

if [[ ! -e .env ]]; then
  echoStep "Creating a dot env file."
  cat <<"DOTENVFILE" > .env
WEB_PORT=3900
API_PORT=3901
ASSETS_PORT=3902
DATABASE_PORT=3910
DATABASE_HOST=localhost
FQDN=lvh.me
LOADBALANCER_HTTP_PORT=8080
LOADBALANCER_HTTPS_PORT=8443
DATABASE_USERNAME=$(whoami)
DATABASE_NAME=blog
DOTENVFILE
fi
source .env

mkdir -p './tmp/pids'
mkdir -p './tmp/nginx/logs'
mkdir -p './tmp/nginx/certificates/'

cp /etc/nginx/mime.types tmp/nginx/mime.types

# Create certificates for nginx to use
if [[ ! -f tmp/nginx/certificates/$FQDN.crt ]]; then

  openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -subj "/C=US/ST=Denial/L=Springfield/O=Dis/CN=$FQDN" -keyout tmp/nginx/certificates/$FQDN.key -out tmp/nginx/certificates/$FQDN.crt

  #only do this on osx (opening so you can accept self signed cert) (may be we can use xdg_open on ubuntu?)
  open tmp/nginx/certificates/$FQDN.crt &
fi
